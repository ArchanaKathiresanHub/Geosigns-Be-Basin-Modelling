#!/bin/ksh
#
# Updates the trunk and branches to the latest release from the repository
#
# Syntax: (called from crontab 
# /nfs/rvl/groups/ept-sg/SWEast/Cauldron/NightlyBuilds/repository/trunk/scripts/NightlyUpdate
#
# Notes:
# 1. This script also updates the location where the other scripts will be called
# 2. This script must be csh so we can call gocbm
################################################################################

# define home directory
#export PERF_HOME="/glb/eu/siep_bv/data/cauldron/nlgla8/develop/trunk/scripts/Performance"
export PERF_HOME="/nfs/rvl/groups/ept-sg/SWEast/Cauldron/Performance"
# define an optional version number
#gempis_version="-v2006.xx"

# define project name
#project=FastTest_16_16.project3d
project=FastTest-120x2.project3d

# setup the user environment
. /etc/profile >/dev/null 

# prepend command to path
export PATH=/apps/sssdev/share:$PATH

# check command format
resource=$1
if [ -z "$resource" ]; then
    echo "Usage: $0 <resource> "
    exit 1
fi

# move into home directory
cd $PERF_HOME

# define the location of the NightlyUpdate logs
TS=`date '+%Y.%m.%d-%H:%M'`
PERFLOG=$PERF_HOME/log/JOB-$resource-$TS.log

#
# indicate the beginning of the test
#
echo "--- Starting at `date`" | tee -a $PERFLOG

# move into test directory
cd FastTest

# find out if resource exists
gempis $resource >res.tmp
result=$?
if [ $result != 0 ]; then
    echo "Error: unknown resource $resource." | tee -a $PERFLOG
    exit 1
fi

cpus_avail=`cat res.tmp | grep AVAILABLE | awk '{ print $4 }'`
echo "Currently [$cpus_avail] processors available" | tee -a $PERFLOG

if [ -z "$cpus_avail" ]; then
    echo "Error: no data $resource." | tee -a $PERFLOG
    exit 1
fi
    
if (( $cpus_avail <= 0 )); then
    echo "No resources available" | tee -a $PERFLOG
    exit
fi

# run gempis job
echo "gempis $gempis_version $resource $cpus_avail fastcauldron -project FastTest_16_16.project3d -temperature | tee -a $PERFLOG"
gempis $gempis_version $resource $cpus_avail fastcauldron -project $project -temperature | tee -a $PERFLOG


# now get out of here
echo "--- Ending at `date`" | tee -a $PERFLOG
exit 0







