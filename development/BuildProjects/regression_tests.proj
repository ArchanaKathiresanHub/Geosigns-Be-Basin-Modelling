<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <Configuration Condition=" '$(Configuration)' == '' ">Release</Configuration>
    <Platform Condition=" '$(Platform)' == '' ">x64</Platform>
  </PropertyGroup>

  <Import Project="$(MSBuildProjectDirectory)\BasinModeling.Linux.Props.xml" />

  <PropertyGroup>
    <script_to_build>fastperformtests_with_cmake</script_to_build>
    <copy_script>$(scp_command) "$(solution_root)\scripts\$(script_to_build)" "$(AgentAccount)@$(AgentHost):bin" </copy_script>
    <execute_script>$(ssh_command) "env SVN_REPO_HOST=$(SvnRepoHost) /bin/sh -x $HOME/bin/$(script_to_build)"  </execute_script>
  </PropertyGroup>

  <PropertyGroup>
    <regression_test_dir Condition="'$(regression_test_dir)' == ''">$(OutDir)regression_tests</regression_test_dir>
    <copy_results_back>$(ssh_command) "set -e ; cd /nfs/rvl/groups/ept-sg/SWEast/Cauldron/ksaho3/RegressionTests ; find -maxdepth 2 -type f | cpio -o" | $(cpio_exe) -id </copy_results_back>
  </PropertyGroup>

  <Target Name="RunTests">

    <RemoveDir Directories="$(regression_test_dir)" Condition="Exists('$(regression_test_dir)')" />
    <MakeDir Directories="$(regression_test_dir)" Condition="!Exists('$(regression_test_dir)')" />
    <Exec IgnoreExitCode="false" Command="$(copy_script)" />
    <!-- 
    <Exec IgnoreExitCode="true" Command="$(execute_script)" />
    -->

    <Message Text="regression_test_dir = $(regression_test_dir)" />
    
    <Exec Condition="'$(SkipCopyResults)' != 'true'"
      Command="$(copy_results_back)"
      WorkingDirectory="$(regression_test_dir)"
      />

  </Target>

  <Target Name="PublishResults">
    <Message Text="solution_root = $(solution_root)" />

    <MSBuild Projects="$(solution_root)\tests\regression_tests\bmtotrx.proj" />
    <MSBuild Projects="$(solution_root)\tests\regression_tests\regression_tests_proxy.proj"  Properties="regression_test_dir=$(regression_test_dir)"/>
  </Target>
  
  <Target Name="Build" DependsOnTargets="DispalyStandardVariables;RunTests;PublishResults">
  </Target>
</Project>