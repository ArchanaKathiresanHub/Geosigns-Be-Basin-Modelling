#!/bin/ksh
#
# BuildAllApps - build all applications defined in the configuration file
#
# Syntax: $0 <number_of_target_bits>
#
# 
################################################################################

# get the numhber of bits I am building for
my_bits=$1
[ -z "$my_bits" ] && my_bits=64

# Define my environment
export TODAY=`date +%a`
export HOST=`hostname | awk -F'.' '{ print $1 }'`

export NIGHTLY_TESTS=$NIGHTLY_HOME/tests
export NIGHTLY_CONFIG=$NIGHTLY_HOME/cfg
export NIGHTLY_LOGS=$NIGHTLY_HOME/logs/$TODAY

# clean up log directory
rm -rf $NIGHTLY_LOGS
mkdir -p $NIGHTLY_LOGS

# get into build directory 
cat $NIGHTLY_CONFIG/builds.cfg | grep -v "^#" | while read line; do

    if [ -z "$line" ]; then
	continue
    fi

    target_bits=`echo $line | awk -F'|' '{ print $1 }'`
    platform=`echo $line | awk -F'|' '{ print $2 }'`
    base_dir=`echo $line | awk -F'|' '{ print $3 }'`
    appname=`echo $line | awk -F'|' '{ print $4 }'`
    owner=`echo $line | awk -F'|' '{ print $5 }'`

    # check if build is to be done for this number of bits
    if [ $target_bits != $my_bits ]; then
	continue
    fi

    # check if build to be done for this platform
    if [ $platform != All ]; then
	skip=yes
	list=`echo $platform | sed 's/,/ /g'`
	for target in $list; do
	    if [ $target = $machine ]; then
		skip=no
	    fi
	done
	if [ $skip = yes ]; then
	    continue
	fi
    fi
    
#    $NIGHTLY_SCRIPTS/BuildApp $base_dir $appname $owner >$NIGHTLY_LOGS/BuildApp.log 2>&1
    $NIGHTLY_SCRIPTS/NightlyBuildApp $base_dir $appname $owner

done

#wait

exit 0


